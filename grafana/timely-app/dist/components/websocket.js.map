{"version":3,"sources":["../../src/components/websocket.js"],"names":[],"mappings":";;;;;;;;;;;;;;;AACQ,mB,wCAAA,a;;;;;;;;;;;;;;;;;;;;;+BAGK,a;AAEX,+BAAY,MAAZ,EAAoB,QAApB,EAA8B,UAA9B,EAA0C,aAA1C,EAAyD;AAAA;;AACvD,eAAK,MAAL,GAAc,MAAd;AACA,eAAK,QAAL,GAAgB,QAAhB;;AAEA,cAAI,QAAQ,IAAI,aAAJ,CAAkB,UAAlB,EAA8B,aAA9B,CAAZ;;AAEA,cAAI,cAAc,MAAM,oBAAN,EAAlB;AACA,eAAK,UAAL,GAAkB,YAAY,CAAZ,EAAe,QAAjC;;AAEA,eAAK,kBAAL,GAA0B,KAA1B;AACA,cAAI,OAAO,SAAX,EAAsB;AAClB,iBAAK,kBAAL,GAA0B,IAA1B;AACH;AACD,eAAK,YAAL,GAAoB,CAApB;AACA,eAAK,MAAL,GAAc,EAAE,UAAU,OAAZ;AACE,oBAAO,EADT;AAEE,yBAAa,CAFf;AAGE,qBAAS;AAHX,WAAd;;AAMA,eAAK,QAAL,GAAgB,KAAhB;AACD;;;;gCAEK,M,EAAO;AACX,iBAAK,QAAL,GAAgB,IAAhB;AACA,gBAAI,OAAO,KAAK,oBAAL,EAAX;AACA,iBAAK,IAAL,GAAY,IAAI,SAAJ,CAAc,IAAd,CAAZ;AACA,iBAAK,IAAL,CAAU,SAAV,GAAsB,KAAK,cAAL,CAAoB,IAApB,CAAyB,IAAzB,CAAtB;AACA,iBAAK,IAAL,CAAU,MAAV,GAAmB,KAAK,WAAL,CAAiB,IAAjB,CAAsB,IAAtB,CAAnB;AACA,iBAAK,IAAL,CAAU,OAAV,GAAoB,KAAK,YAAL,CAAkB,IAAlB,CAAuB,IAAvB,CAApB;AACD;;;+BAEI,M,EAAQ;AACX,iBAAK,QAAL,GAAgB,KAAhB;AACA,iBAAK,IAAL,CAAU,KAAV;AACD;;;yCAEc,O,EAAQ;AACrB;AACA,gBAAI,SAAS,KAAK,KAAL,CAAW,QAAQ,IAAnB,CAAb;;AAEA,iBAAK,MAAL,CAAY,MAAZ,GAAqB,OAAO,MAA5B;AACA,iBAAK,MAAL,CAAY,SAAZ,GAAwB,OAAO,SAA/B;AACA,iBAAK,MAAL,CAAY,KAAZ,GAAoB,OAAO,KAA3B;AACA,iBAAK,MAAL,CAAY,IAAZ,GAAmB,OAAO,IAA1B;AACA,iBAAK,YAAL,GAAoB,KAAK,YAAL,GAAkB,CAAtC;AACA,iBAAK,MAAL,CAAY,OAAZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD;;;wCAEY;AACX,gBAAI,SAAS;AACX,2BAAc,QADH;AAEX,gCAAmB;AAFR,aAAb;AAIA,iBAAK,IAAL,CAAU,IAAV,CAAe,KAAK,SAAL,CAAe,MAAf,CAAf;;AAEA,gBAAI,KAAK;AACP,2BAAc,KADP;AAEP,gCAAmB,OAFZ;AAGP,wBAAW;AAHJ,aAAT;AAKA,iBAAK,IAAL,CAAU,IAAV,CAAe,KAAK,SAAL,CAAe,EAAf,CAAf;;AAEJ;AACA;AACA;AACA;AACA;AACA;AACG;;;yCAEa;AACZ,oBAAQ,GAAR,CAAY,kBAAZ;AACD;;;iDAEqB;AACpB,mBAAO,WAAW,KAAK,UAAL,CAAgB,UAA3B,GAAwC,GAAxC,GAA8C,KAAK,UAAL,CAAgB,MAA9D,GAAuE,YAA9E;AACD;;;;;;;;AAGH,oBAAc,WAAd,GAA4B,2BAA5B;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"websocket.js","sourcesContent":["\nimport {AuthsPageCtrl} from 'plugins/timely-app/components/authspage'\n\n\nexport class WebsocketCtrl {\n\n  constructor($scope, $timeout, backendSrv, datasourceSrv) {\n    this.$scope = $scope;\n    this.$timeout = $timeout;\n\n    var actrl = new AuthsPageCtrl(backendSrv, datasourceSrv);\n\n    var datasources = actrl.getTimelyDatasources();\n    this.datasource = datasources[0].jsonData;\n\n    this.websocketSupported = false;\n    if( window.WebSocket ){\n        this.websocketSupported = true;\n    }\n    this.metric_count = 0;\n    this.metric = { 'metric': 'empty',\n                    'tags':[],\n                    'timestamp': 0,\n                    'value': 0.0\n                    };\n\n    this.fetching = false;\n  }\n\n  start(metric){\n    this.fetching = true;\n    var addr = this._getWebsocketAddress();\n    this.sock = new WebSocket(addr);\n    this.sock.onmessage = this._handleMessage.bind(this);\n    this.sock.onopen = this._handleOpen.bind(this);\n    this.sock.onclose = this._handleClose.bind(this);\n  }\n\n  stop(metric) {\n    this.fetching = false;\n    this.sock.close();\n  }\n\n  _handleMessage(message){\n    //console.log('handleMessage');\n    var metric = JSON.parse(message.data);\n\n    this.metric.metric = metric.metric;\n    this.metric.timestamp = metric.timestamp;\n    this.metric.value = metric.value;\n    this.metric.tags = metric.tags;\n    this.metric_count = this.metric_count+1;\n    this.$scope.$digest();\n    //if( this.metrics.length >= 16){\n    //    this.metrics.shift();\n    //}\n    //this.$scope.$apply( function(){\n    //        this.metrics.push(metric);\n    //        this.metric_count = this.metric_count + 1;\n    //        }.bind(this));\n  }\n\n  _handleOpen(){\n    var create = {\n      \"operation\" : \"create\",\n      \"subscriptionId\" : \"12345\"\n    }\n    this.sock.send(JSON.stringify(create));\n\n    var m1 = {\n      \"operation\" : \"add\",\n      \"subscriptionId\" : \"12345\",\n      \"metric\" : \"sys.cpu.user\"\n    }\n    this.sock.send(JSON.stringify(m1));\n\n//    var m2 = {\n//      \"operation\" : \"add\",\n//      \"subscriptionId\" : \"12345\",\n//      \"metric\" : \"timely.keys.metric.inserted\"\n//    }\n//    this.sock.send(JSON.stringify(m2));\n  }\n\n  _handleClose(){\n    console.log(\"Websocket Closed\")\n  }\n\n  _getWebsocketAddress(){\n    return \"wss://\" + this.datasource.timelyHost + \":\" + this.datasource.wsPort + \"/websocket\";\n  }\n\n}\nWebsocketCtrl.templateUrl = 'components/websocket.html';\n\n\n// example metric message\n//{\n//  \"metric\" : \"sys.cpu.user\",\n//  \"timestamp\":1469028728091,\n//  \"value\":1.0,\n//  \"tags\":\n//  [\n//    {\n//      \"key\":\"rack\",\n//      \"value\":\"r1\"\n//    },{\n//      \"key\":\"tag3\",\n//      \"value\":\"value3\"\n//    },{\n//      \"key\":\"tag4\",\n//      \"value\":\"value4\"\n//    }\n//  ],\n//  \"subscriptionId\":\"<unique id>\"\n//}\n"]}